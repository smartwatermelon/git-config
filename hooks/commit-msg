#!/usr/bin/env bash
set -euo pipefail

# =========================================================
# COMMIT MESSAGE VALIDATION - Conventional Commits Format
# =========================================================
#
# Enforces conventional commits format:
#   <type>(<scope>): <description>
#
# Valid types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert
# Scope is optional
# Description must be present and start with lowercase
#
# Examples:
#   âœ… feat(auth): add JWT token refresh
#   âœ… fix: resolve memory leak in parser
#   âœ… docs(api): update authentication guide
#   âŒ Add new feature (missing type)
#   âŒ FEAT: new feature (type must be lowercase)
#

COMMIT_MSG_FILE="$1"

# Read the first line of the commit message
FIRST_LINE=$(head -1 "${COMMIT_MSG_FILE}")

# Skip validation for merge commits
if [[ "${FIRST_LINE}" =~ ^Merge ]]; then
  exit 0
fi

# Conventional commits regex pattern
# Format: type(optional-scope): description
PATTERN='^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\([a-z0-9-]+\))?: .{1,}'

if ! echo "${FIRST_LINE}" | grep -qE "${PATTERN}"; then
  echo "" >&2
  echo "ðŸ›‘ COMMIT MESSAGE VALIDATION FAILED" >&2
  echo "" >&2
  echo "Commit message must follow conventional commits format:" >&2
  echo "  <type>(<scope>): <description>" >&2
  echo "" >&2
  echo "Valid types:" >&2
  echo "  feat     - New feature" >&2
  echo "  fix      - Bug fix" >&2
  echo "  docs     - Documentation changes" >&2
  echo "  style    - Code style/formatting (no logic change)" >&2
  echo "  refactor - Code refactoring" >&2
  echo "  test     - Adding or updating tests" >&2
  echo "  chore    - Maintenance tasks" >&2
  echo "  perf     - Performance improvements" >&2
  echo "  ci       - CI/CD changes" >&2
  echo "  build    - Build system changes" >&2
  echo "  revert   - Revert previous commit" >&2
  echo "" >&2
  echo "Your message:" >&2
  echo "  ${FIRST_LINE}" >&2
  echo "" >&2
  echo "Examples of valid messages:" >&2
  echo "  feat(auth): add JWT token refresh" >&2
  echo "  fix: resolve memory leak in parser" >&2
  echo "  docs(api): update authentication guide" >&2
  echo "" >&2
  echo "To bypass (emergency only): git commit --no-verify" >&2
  echo "" >&2
  exit 1
fi

# Optional: Check for subject line length (recommended max 72 chars)
SUBJECT_LENGTH=${#FIRST_LINE}
if [[ ${SUBJECT_LENGTH} -gt 72 ]]; then
  echo "" >&2
  echo "âš ï¸  WARNING: Subject line is ${SUBJECT_LENGTH} characters (recommended max: 72)" >&2
  echo "" >&2
  echo "Consider shortening your message or moving details to the body." >&2
  echo "" >&2
  # This is a warning, not an error - don't exit 1
fi

exit 0

#!/usr/bin/env bash
set -euo pipefail

# =========================================================
# BRANCH PROTECTION - Do not commit directly to main/master
# =========================================================
protected_branch_check() {
  local current_branch
  current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

  if [[ "${current_branch}" == "main" || "${current_branch}" == "master" ]]; then
    echo "" >&2
    echo "ðŸ›‘ STOP: Direct commits to '${current_branch}' are not allowed." >&2
    echo "" >&2
    echo "   Create a feature branch first:" >&2
    echo "   git checkout -b <branch-name>" >&2
    echo "" >&2
    echo "   If you REALLY need to bypass this (you probably don't):" >&2
    echo "   git commit --no-verify" >&2
    echo "" >&2
    exit 1
  fi
}
protected_branch_check

# Prefer repo-local config if it exists, otherwise fall back to global
LOCAL_CONFIG=".pre-commit-config.yaml"
GLOBAL_CONFIG="${HOME}/.config/pre-commit/config.yaml"

if ! command -v pre-commit >/dev/null 2>&1; then
  echo "[pre-commit] ERROR: 'pre-commit' command not found in PATH." >&2
  exit 1
fi

if [[ -f "${LOCAL_CONFIG}" ]]; then
  echo "[pre-commit] Running with repo-local config: ${LOCAL_CONFIG}"
  pre-commit run "$@" || exit 1
elif [[ -f "${GLOBAL_CONFIG}" ]]; then
  echo "[pre-commit] Running with global config: ${GLOBAL_CONFIG}"
  pre-commit run --config "${GLOBAL_CONFIG}" "$@" || exit 1
else
  echo "[pre-commit] ERROR: No config found (expected ${LOCAL_CONFIG} or ${GLOBAL_CONFIG})." >&2
  exit 1
fi

# =========================================================
# AUTOMATED CODE REVIEW (runs only if pre-commit passes)
# =========================================================
REVIEW_SCRIPT="${HOME}/.claude/hooks/run-review.sh"

if [[ -x "${REVIEW_SCRIPT}" ]]; then
  # Get staged diff and pipe to review
  if ! git diff --cached | "${REVIEW_SCRIPT}"; then
    echo "" >&2
    echo "ðŸ›‘ Commit blocked by code review." >&2
    echo "   Address the issues above and try again." >&2
    echo "" >&2
    echo "   To bypass (emergency only): git commit --no-verify" >&2
    echo "" >&2
    exit 1
  fi
else
  echo "[pre-commit] Warning: Review script not found or not executable" >&2
  echo "[pre-commit] Expected: ${REVIEW_SCRIPT}" >&2
  echo "[pre-commit] Skipping automated review" >&2
fi

exit 0

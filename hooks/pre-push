#!/usr/bin/env bash
set -euo pipefail

# =========================================================
# BRANCH PROTECTION - Do not push directly to main/master
# =========================================================
protected_branch_check() {
  local current_branch
  current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

  if [[ "${current_branch}" == "main" || "${current_branch}" == "master" ]]; then
    echo "" >&2
    echo "ðŸ›‘ STOP: Direct pushes to '${current_branch}' are not allowed." >&2
    echo "" >&2
    echo "   Use the PR workflow: branch â†’ push â†’ PR â†’ merge" >&2
    echo "" >&2
    echo "   If you REALLY need to bypass this (you probably don't):" >&2
    echo "   git push --no-verify" >&2
    echo "" >&2
    exit 1
  fi
}
protected_branch_check

# =========================================================
# CONFIGURATION HARDLINKS (Pre-push)
# =========================================================

# Color output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
  echo -e "${BLUE}[PRE-PUSH]${NC} $*"
}

log_success() {
  echo -e "${GREEN}[PRE-PUSH]${NC} $*"
}

log_warning() {
  echo -e "${YELLOW}[PRE-PUSH]${NC} $*"
}

ensure_config_hardlinks() {
  local repo_root
  repo_root=$(git rev-parse --show-toplevel)

  # Define config mappings: global_path:repo_filename
  local configs=(
    "${HOME}/.config/shellcheck/.shellcheckrc:.shellcheckrc"
    "${HOME}/.config/yamllint/config:.yamllint"
  )

  local any_updated=false

  for config_mapping in "${configs[@]}"; do
    local global_config="${config_mapping%:*}"
    local repo_filename="${config_mapping#*:}"
    local repo_config="${repo_root}/.github/workflows/${repo_filename}"

    if [[ -f "${global_config}" ]]; then
      # Ensure .github/workflows directory exists
      mkdir -p "${repo_root}/.github/workflows"

      # Check if repo config is missing or different
      if [[ ! -f "${repo_config}" ]] || ! cmp -s "${global_config}" "${repo_config}"; then
        # Remove existing repo config (file or broken link)
        rm -f "${repo_config}"
        # Create hardlink to global config
        if ln "${global_config}" "${repo_config}" 2>/dev/null; then
          log_success "âœ… Updated ${repo_filename} in .github/workflows/ from global config"
          # Stage it for inclusion in push
          if git add "${repo_config}" 2>/dev/null; then
            log "   â†’ File staged and will be included in this push"
          else
            log_warning "   âš ï¸  Could not stage ${repo_filename} (already committed or git error)"
          fi
          any_updated=true
        else
          log_warning "âš ï¸  Could not create hardlink for ${repo_filename} (cross-filesystem)"
          # Fallback to copy
          cp "${global_config}" "${repo_config}"
          if git add "${repo_config}" 2>/dev/null; then
            log_success "ðŸ“‹ Copied ${repo_filename} to .github/workflows/ from global config"
            log "   â†’ File staged and will be included in this push"
          else
            log_success "ðŸ“‹ Copied ${repo_filename} to .github/workflows/ from global config"
            log_warning "   âš ï¸  Could not stage ${repo_filename} (already committed or git error)"
          fi
          any_updated=true
        fi
      fi
    elif [[ ! -f "${repo_config}" ]]; then
      log_warning "âš ï¸  No ${repo_filename} config found (neither global nor repo)"
    fi
  done

  if [[ "${any_updated}" == true ]]; then
    echo "" >&2
    log_success "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    log_success "ðŸ”„ CONFIG SYNC: Files have been auto-staged for this push"
    log_success "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    log "Config files in .github/workflows/ have been synced from global configs"
    log "These files are now staged and will be included in your push"
    echo "" >&2
  else
    log "âœ… All config files in .github/workflows/ are up to date"
  fi
}

# Check if remote is GitHub
is_github_remote() {
  local remote_url
  remote_url=$(git remote get-url origin 2>/dev/null || echo "")

  if [[ "${remote_url}" =~ github\.com ]]; then
    return 0
  else
    return 1
  fi
}

# Check if GitHub workflows exist that use config files
has_github_workflows_using_configs() {
  local repo_root
  repo_root=$(git rev-parse --show-toplevel)

  # Check if .github/workflows directory exists
  if [[ ! -d "${repo_root}/.github/workflows" ]]; then
    return 1
  fi

  # Check if any workflow files reference the config files we manage
  if grep -r "\.shellcheckrc\|\.yamllint" "${repo_root}/.github/workflows/" >/dev/null 2>&1; then
    return 0
  else
    return 1
  fi
}

# Main execution
if is_github_remote && has_github_workflows_using_configs; then
  log "GitHub remote with CI workflows detected - syncing configuration files before push..."
  ensure_config_hardlinks
elif is_github_remote; then
  log "GitHub remote detected but no workflows use config files - skipping config sync"
else
  log "Non-GitHub remote detected - skipping config sync"
fi

log_success "Pre-push config sync complete!"

#!/usr/bin/env bash
# Auto-generated by global infrastructure setup
# Creates .claude/ infrastructure in new repositories
#
# This hook runs after:
# - git init (if template configured)
# - git clone (always)
# - git checkout (when switching branches)
#
# We only want to run on initial checkout, not on every branch switch.

set -euo pipefail

# Hook parameters from git
_prev_head=$1 # Unused - we only care about branch_checkout
_new_head=$2  # Unused - we only care about branch_checkout
branch_checkout=$3

# Only run on initial checkout (git init or git clone)
# branch_checkout == 1 means checking out a branch (not just updating files)
# For git init, prev_head is all zeros (0000000...)
# For git clone, this runs on the initial checkout
if [[ "${branch_checkout}" != "1" ]]; then
  exit 0
fi

# Only run if .claude/ doesn't already exist
# This prevents overwriting existing project infrastructure
if [[ -d ".claude" ]]; then
  exit 0
fi

# Get the template location from git config
TEMPLATE_DIR=$(git config --get init.templateDir 2>/dev/null || echo "")
if [[ -z "${TEMPLATE_DIR}" ]]; then
  # Fallback if not configured (shouldn't happen, but be defensive)
  TEMPLATE_DIR="${HOME}/.config/git/template"
fi

# Expand tilde in path
TEMPLATE_DIR="${TEMPLATE_DIR/#\~/${HOME}}"
CLAUDE_TEMPLATE="${TEMPLATE_DIR}/.claude-template"

# If template source doesn't exist, skip silently
# This allows the hook to exist even if template isn't set up yet
if [[ ! -d "${CLAUDE_TEMPLATE}" ]]; then
  exit 0
fi

# Create .claude/ structure in working directory
echo "ðŸ”§ Initializing Claude Code infrastructure..."

# Copy template structure
cp -r "${CLAUDE_TEMPLATE}" ".claude"

# Ensure extensions directory exists
mkdir -p ".claude/hooks/extensions"

# Make example extension non-executable (disabled by default)
if [[ -f ".claude/hooks/extensions/example.sh.disabled" ]]; then
  chmod -x ".claude/hooks/extensions/example.sh.disabled"
fi

echo "âœ… Claude Code infrastructure created in .claude/"
echo ""
echo "Next steps:"
echo "  1. Review .claude/README.md for project-specific setup"
echo "  2. Edit .claude/config.sh with project settings (if needed)"
echo "  3. Add custom extensions in .claude/hooks/extensions/ (if needed)"
echo ""
echo "Documentation: ~/.claude/docs/INFRASTRUCTURE.md"

exit 0
